<!---
说明：GitHub Copilot 翻译
--->
[English](/docs/sync_algorithm_v1.md) | 中文

# 同步算法

## 数据源

我们有三个记录源：

1. 本地文件。通过在本地扫描所有文件来获取。实际上，Obsidian直接提供了一个API来返回这些文件。
2. 远程文件。通过在远程服务上扫描所有文件来获取。一些服务直接提供了一个API来返回这些文件，而其他一些服务则需要插件递归扫描文件夹。
3. 本地的“删除或重命名”历史记录。通过使用Obsidian的跟踪API记录。因此，如果用户在Obsidian之外删除或重命名文件/文件夹，我们无法做任何操作。

假设所有的数据源都是可靠的。

## 处理它们

我们列出了所有互斥且完全穷尽的组合。

| ID  | 远程文件 | 本地文件 | 本地删除重命名历史记录 | 额外条件                                                                      | 决策                                                                                                     |
| --- | -------- | -------- | --------------------- | ----------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------- |
| 1   | 存在     | 存在     | 忽略                  | mtime_remote > mtime_local                                                    | 下载远程文件，如果不存在则创建本地文件夹，如果存在则清除本地历史记录                                     |
| 2   | 存在     | 存在     | 忽略                  | mtime_remote < mtime_local                                                    | 上传本地文件，如果不存在则创建远程文件夹，如果存在则清除本地历史记录                                     |
| 3   | 存在     | 存在     | 忽略                  | mtime_remote === mtime_local && password === "" && size_remote === size_local | 清除本地历史记录（文件已同步且上次同步后未发生更改）                                                       |
| 4   | 存在     | 存在     | 忽略                  | mtime_remote === mtime_local && password === "" && size_remote !== size_local | 上传本地文件，如果存在则清除本地历史记录（我们始终优先选择本地文件）                                       |
| 5   | 存在     | 存在     | 忽略                  | mtime_remote === mtime_local && password !== ""                               | 清除本地历史记录（在加密模式下，文件大小不相等，我们只能依赖mtime）                                       |
| 6   | 存在     | 存在     | 忽略                  | 如果本地是一个文件夹，mtime_local === undefined                               | 清除本地历史记录。TODO：如果一个文件夹和一个之前的文件共享相同的名称会怎样？                               |
| 7   | 存在     | 不存在   | 存在                  | mtime_remote >= delete_time_local                                             | 下载远程文件，如果不存在则创建文件夹                                                                   |
| 8   | 存在     | 不存在   | 存在                  | mtime_remote < delete_time_local                                              | 删除远程文件，清除本地历史记录                                                                         |
| 9   | 存在     | 不存在   | 不存在                |                                                                               | 下载远程文件，如果不存在则创建文件夹                                                                   |
| 10  | 不存在   | 存在     | 忽略                  | 本地可能是文件夹或文件                                                         | 递归上传本地文件，如果不存在则创建远程文件夹，如果存在则清除本地历史记录                                 |
| 11  | 不存在   | 不存在   | 忽略                  |                                                                               | 清除本地历史记录                                                                                         |
